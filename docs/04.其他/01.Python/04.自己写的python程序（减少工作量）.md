


## 拼接sql

```python
import pandas as pd
import collections

filepath = 'data\GD_ISSUE_PLAN.csv'

# 读取文件
df = pd.read_csv(filepath, sep='\t', header = None)

# 获取第一列并去重
tag_table = df[0].drop_duplicates().values[0]  
# 获取源表
source_tables = df[3].drop_duplicates().dropna().values   # ndarray类型

# 表名和别名放入字典
num = 0
# dic = { tag_table: "T{}".format(num) }
dic = collections.OrderedDict()
for table in source_tables:
    num += 1
    dic[table] = "T{}".format(num)

list1 = ["SELECT"]

# 目标表名 目标字段名 源表表名 源表字段名
columns = df.iloc[:, [0,1,3,4]]

source_ad_table = ''   # 区划在哪个源表
source_agency_table = ''  # 单位在哪个源表
# 拼接select部分
for row in range(0, columns.shape[0]):
    if pd.isna(columns[4][row]):
        if row != 0 :
            list1.append("\n\t  ,{} AS {}".format("''", columns[1][row]))
        else:
            list1.append("\n\t   {} AS {}".format("''", columns[1][row]))
    else:
        tablename = dic[columns[3][row]]
        if columns[1][row] == "MOF_DIV_CODE":
            num += 1
            list1.append( "\n\t  ,NVL(T{}.CZ_AD_CODE, {}.AD_CODE) AS {}".format(num, tablename, columns[1][row]) )
            dic["AD_CODE_TABLE"] = "T{}".format(num)
            source_ad_table = columns[3][row]
        elif columns[1][row] in ("AGENCY_CODE", "AGENCY_COD"):
            num += 1
            list1.append( "单位代码(待完善)" )
            dic["AGENCY_CODE_TALE"] = "T{}".format(num)
        else :
            if row != 0 :
                list1.append("\n\t  ,{}.{} AS {}".format(tablename, columns[4][row], columns[1][row]))
            else:
                list1.append("\n\t   {}.{} AS {}".format(tablename, columns[4][row], columns[1][row]))

# 拼接from和join部分
index = 0
for key in dic:
    index += 1
    if index == 1:
        list1.append("\n     FROM {} {}".format(key, dic[key]))
    else:
        if key == "AD_CODE_TABLE":
            list1.append("\nLEFT JOIN {} {}\n       ON {}.AD_CODE = {}.AD_CODE".format(key, dic[key], dic[source_ad_table], dic[key]))
        elif columns[1][row] in ("AGENCY_CODE", "AGENCY_COD"):
            pass
        else:
            list1.append("\nLEFT JOIN {} {}\n       ON".format(key, dic[key]))

# dic
# list1
print( ' '.join(list1) )

# df
columns
```