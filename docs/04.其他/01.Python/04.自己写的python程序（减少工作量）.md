


## 拼接sql

```python
import pandas as pd
import collections

t_name = "GD_ISSUE_PLAN"

filepath = 'data\{}.csv'.format(t_name)

# 读取文件
df = pd.read_csv(filepath, sep='\t', header = None)

# 获取第一列并去重
tag_table = df[0].drop_duplicates().values[0]  
# 获取源表
source_tables = df[3].drop_duplicates().dropna().values   # ndarray类型

# 表名和别名放入字典
num = 0
# dic = { tag_table: "T{}".format(num) }
dic = collections.OrderedDict()
for table in source_tables:
    num += 1
    dic[table] = "T{}".format(num)

cols = ",".join(df.iloc[:, 1])

list1 = []
list1.append("INSERT INTO {}({})".format(t_name, cols))
list1.append("\nSELECT")

# 目标表名 目标字段名 源表表名 源表字段名
columns = df.iloc[:, [0,1,3,4]]

source_ad_table = ''   # 区划在哪个源表
source_agency_table = ''  # 单位在哪个源表 ?哪个字段关联
# 拼接select部分
for row in range(0, columns.shape[0]):
    if pd.isna(columns[4][row]):
        if row != 0 :
            list1.append("\n\t  ,{} AS {}".format("''", columns[1][row]))
        else:
            list1.append("\n\t   {} AS {}".format("''", columns[1][row]))
    else:
        tablename = dic[columns[3][row]]
        # 处理区划
        if columns[1][row] == "MOF_DIV_CODE":
            num += 1
            list1.append( "\n\t  ,NVL(T{}.CZ_CODE, {}.AD_CODE) AS {}".format(num, tablename, columns[1][row]) )
            dic["DSY_V_ELE_AD"] = "T{}".format(num)
            source_ad_table = columns[3][row]
        # 处理单位
        elif columns[1][row] in ("AGENCY_CODE", "AGENCY_COD"):
            num += 1
            list1.append( "\n\t  ,CASE WHEN T{}.CODE IS NULL THEN {}.AG_CODE ELSE T{}.AGENCY_CODE END AS AGENCY_CODE".format(num, tablename, num) )
            dic["BDA_T_DWDZ"] = "T{}".format(num)
            source_agency_table = columns[3][row]
        # 处理时间
        elif columns[1][row].endswith( ("TIME", "DATE") ) : #, beg=[0, len(str)]
            list1.append("\n\t  ,regexp_replace({}.{}, '-|:| ', '') AS {}".format(tablename, columns[4][row], columns[1][row]))
        else :
            if row != 0 :
                list1.append("\n\t  ,{}.{} AS {}".format(tablename, columns[4][row], columns[1][row]))
            else:
                list1.append("\n\t   {}.{} AS {}".format(tablename, columns[4][row], columns[1][row]))

# 拼接from和join部分
index = 0
for key in dic:
    index += 1
    if index == 1:
        list1.append("\n     FROM {} {}".format(key, dic[key]))
    else:
        if key == "DSY_V_ELE_AD":
            list1.append("\nLEFT JOIN {} {}\n       ON {}.AD_CODE = {}.CODE".format(key, dic[key], dic[source_ad_table], dic[key]))
        elif key == "BDA_T_DWDZ":
            list1.append("\nLEFT JOIN {} {}\n       ON {}.AG_ID = {}.GUID".format(key, dic[key], dic[source_agency_table], dic[key]))
        else:
            list1.append("\nLEFT JOIN {} {}\n       ON ".format(key, dic[key]))

# dic
# list1
print( ' '.join(list1) )

# df
columns
# cols
```