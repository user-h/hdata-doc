---
title: 自己写的python程序（减少工作量）
date: 2022-03-15 09:04:59
permalink: /pages/c2b99b/
---



## 拼接sql

```text
GD_STOCK_PAYMENT	PAY_ID	偿还信息主键	DEBT_T_ZWGL_CHBJ	CHBJ_ID	偿还本金主单ID
GD_STOCK_PAYMENT	DEPT_STOCK_ID	债务信息主键	DEBT_T_ZWGL_CHBJ	ZW_ID	债务ID
GD_STOCK_PAYMENT	MOF_DIV_CODE	财政区划代码	DEBT_T_ZWGL_CHBJ	AD_CODE	区划编码
GD_STOCK_PAYMENT	AGENCY_CODE	单位代码	DEBT_T_ZWGL_CHBJ	AG_CODE	单位编码
```
```python
import pandas as pd
import collections

t_name = "GD_ISSUE_PLAN"

filepath = 'data\{}.csv'.format(t_name)

# 读取文件
df = pd.read_csv(filepath, sep='\t', header = None)

# 获取第一列并去重
tag_table = df[0].drop_duplicates().values[0]  
# 获取源表
source_tables = df[3].drop_duplicates().dropna().values   # ndarray类型

# 表名和别名放入字典
num = 0
# dic = { tag_table: "T{}".format(num) }
dic = collections.OrderedDict()
for table in source_tables:
    num += 1
    dic[table] = "T{}".format(num)

cols = ",".join(df.iloc[:, 1])

list1 = []
list1.append("INSERT INTO {}({})".format(tag_table, cols))
list1.append("\nSELECT")

# 目标表名 目标字段名 源表表名 源表字段名
columns = df.iloc[:, [0,1,3,4]]

source_ad_table = ''   # 区划在哪个源表
source_agency_table = ''  # 单位在哪个源表 ?哪个字段关联
# 拼接select部分
for row in range(0, columns.shape[0]):
    if pd.isna(columns[4][row]):
        if row != 0 :
            list1.append("\n\t  ,{} AS {}".format("''", columns[1][row]))
        else:
            list1.append("\n\t   {} AS {}".format("''", columns[1][row]))
    else:
        tablename = dic[columns[3][row]]
        # 处理区划
        if columns[1][row] == "MOF_DIV_CODE":
            num += 1
            list1.append( "\n\t  ,NVL(T{}.CZ_CODE, {}.AD_CODE) AS {}".format(num, tablename, columns[1][row]) )
            dic["DSY_V_ELE_AD"] = "T{}".format(num)
            source_ad_table = columns[3][row]
        # 处理单位
        elif columns[1][row] in ("AGENCY_CODE", "AGENCY_COD"):
            num += 1
            list1.append( "\n\t  ,CASE WHEN T{}.CODE IS NULL THEN {}.AG_CODE ELSE T{}.AGENCY_CODE END AS AGENCY_CODE".format(num, tablename, num) )
            dic["BDA_T_DWDZ"] = "T{}".format(num)
            source_agency_table = columns[3][row]
        # 处理时间
        elif columns[1][row].endswith( ("TIME", "DATE") ) : #, beg=[0, len(str)]
            list1.append("\n\t  ,regexp_replace({}.{}, '-|:| ', '') AS {}".format(tablename, columns[4][row], columns[1][row]))
        else :
            if row != 0 :
                list1.append("\n\t  ,{}.{} AS {}".format(tablename, columns[4][row], columns[1][row]))
            else:
                list1.append("\n\t   {}.{} AS {}".format(tablename, columns[4][row], columns[1][row]))

# 拼接from和join部分
index = 0
for key in dic:
    index += 1
    if index == 1:
        list1.append("\n     FROM {}@DSY_HBDZ_DBLINK {}".format(key, dic[key]))
    else:
        if key == "DSY_V_ELE_AD":
            list1.append("\nLEFT JOIN {} {}\n       ON case when {}.AD_CODE='4200' then '420000' when {}.AD_CODE='4290'  then '4298' else {}.AD_CODE end = {}.CODE".format(key, dic[key], dic[source_ad_table],dic[source_ad_table],dic[source_ad_table], dic[key]))
        elif key == "BDA_T_DWDZ":
            list1.append("\nLEFT JOIN {} {}\n       ON {}.AG_ID = {}.GUID".format(key, dic[key], dic[source_agency_table], dic[key]))
        else:
            list1.append("\nLEFT JOIN {}@DSY_HBDZ_DBLINK {}\n       ON ".format(key, dic[key]))

# dic
# list1
print( ' '.join(list1) )

# df
columns
# cols
```

修改加一列

```text
GD_STOCK_PAYMENT	PAY_ID	偿还信息主键	DEBT_T_ZWGL_CHBJ	CHBJ_ID	偿还本金主单ID	CHBJ_ID
GD_STOCK_PAYMENT	DEPT_STOCK_ID	债务信息主键	DEBT_T_ZWGL_CHBJ	ZW_ID	债务ID	ZW_ID
GD_STOCK_PAYMENT	MOF_DIV_CODE	财政区划代码	DEBT_T_ZWGL_CHBJ	AD_CODE	区划编码	AD_CODE
GD_STOCK_PAYMENT	AGENCY_CODE	单位代码	DEBT_T_ZWGL_CHBJ	AG_CODE	单位编码	AG_CODE
						PAY_ID
						DEPT_STOCK_ID
						MOF_DIV_CODE
						AGENCY_CODE

```

```python
修改：
df0 = pd.read_csv(filepath, sep='\t', header = None)
df = df0.iloc[:, [0,1,2,3,4,5]].dropna(thresh=2)



df2 = df0.iloc[:, [1,4,6]] #5

dic2 = {}
list2 = []
# 赋值
for row in range(0, df2.shape[0]):
    if( pd.isna(df2[4][row]) ):
        pass
    else:
        dic2[df2[4][row]] = df2[1][row]

for row in range(0, df2.shape[0]):
    if pd.isna(df2[6][row]):
        pass
    else:
        if df2[6][row] in dic2.keys():
            list2.append("\n,{} as {}".format( dic2[df2[6][row]], df2[6][row] ) )
        else:
            list2.append("\n,null as {}".format(df2[6][row]) )

print("".join(list2))
# df2
# dic2
```