
### 常用命令

#### 启动服务

```shell
# 单节点启动
./bin/kafka-server-start.sh -daemon config/server.properties
```

CDH 安装kafka需修改配置：
- zookeeper.chroot：kafka在zookeeper节点的存储位置
- kafka.properties 的Kafka Broker高级配置代码（配置监听）：listeners=PLAINTEXT://:9092


#### 📌 Topic 管理

两种创建topic方式，一种offset存储到zookeeper，另一种offset存储到kafka的默认topic

**通过--zookeeper选项指定Zookeeper的地址**

|功能| 命令                                                                                                |
|---|---------------------------------------------------------------------------------------------------|
|查看所有 Topic| `kafka-topics --zookeeper banana:2181[/kafka] --list`                                             |
|查看 Topic 详情| `kafka-topics --zookeeper 10.221.70.124:2181 --describe --topic test`                             |
|创建 Topic| `kafka-topics --zookeeper banana:2181 --create --topic test --partitions 1 --replication-factor 2` |
|删除 Topic| `kafka-topics --zookeeper banana:2181 --delete --topic test`                                      |


**通过--bootstrap-server选项指定Kafka broker的地址**

--bootstrap和--zookeeper都可以，但官方推荐使用Kafka的bootstrap-server来创建主题，因为这是Kafka未来发展的方向，也是更稳定、更高效的做法。

|功能| 命令                                                                                                |
|---|---------------------------------------------------------------------------------------------------|
|查看所有 Topic| `kafka-topics --list --bootstrap-server banana:9092`                                              |
|查看 Topic 详情| `kafka-topics --describe --topic topic1 --bootstrap-server banana:9092`                           |
|创建 Topic| `kafka-topics --create --topic test --partitions 3 --replication-factor 1 --bootstrap-server banana:9092` |
|删除 Topic| `kafka-topics --delete --topic test --bootstrap-server banana:9092`                               |

---

#### 📌 生产者 & 消费者（sasl认证需要加--xxx.config /xx/xxx.properties）

| 功能            | 命令                                                                                                                                            |
|---------------|-----------------------------------------------------------------------------------------------------------------------------------------------|
| 启动生产者（写消息）    | `kafka-console-producer --topic test --broker-list banana:9092 [--producer.config /etc/kafka/conf/producer.properties]`                       |
| 启动消费者（读消息）    | `kafka-console-consumer --topic test --from-beginning --bootstrap-server banana:9092 [--consumer.config /etc/kafka/conf/consumer.properties]` |
| 指定消费者组  | `kafka-console-consumer --topic test --consumer-property group.id=group1 --bootstrap-server banana:9092`                                      |
| 指定消费者组并限制消息数  | `kafka-console-consumer --topic test --group group1 --from-beginning --max-messages 100 --bootstrap-server banana:9092`                       |
| 消费者从指定位置开始消费  | `kafka-console-consumer --topic test --offset 10 --partition 0 --bootstrap-server banana:9092`                                                |
| 查看消费者组列表      | `kafka-consumer-groups --list --bootstrap-server banana:9092 [--command-config /etc/kafka/conf/consumer.properties]`                                                                              |
| 查看消费者组详情      | `kafka-consumer-groups --describe --group group1 --bootstrap-server banana:9092`                                                              |
| 重置消费者组 offset | `kafka-consumer-groups --bootstrap-server banana:9092 --group group1 --reset-offsets --to-earliest【--to-latest】 --execute --topic test`       |


---

#### 📌 SASL 用户管理（SCRAM）

> ⚠️ 前提：Kafka 开启 **SASL/SCRAM** 认证

entity-type：[List(topics, clients, users, brokers)]

| 功能       | 命令                                                                                                                                                                                                                 |
|----------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 添加用户     | `kafka-configs --zookeeper banana:2181/kafka --alter --add-config 'SCRAM-SHA-256=[iterations=4096,password=admin-sec],SCRAM-SHA-512=[iterations=4096,password=admin-sec]' --entity-type users --entity-name admin` |
| 查看用户列表   | `kafka-configs --zookeeper banana:2181 --describe --entity-type users`                                                                                                                                             |
| 查看用户配置   | `kafka-configs --zookeeper banana:2181 --describe --entity-type users --entity-name admin`                                                                                                                         |
| 删除用户     | `kafka-configs --zookeeper banana:2181 --alter --delete-config 'SCRAM-SHA-256' --entity-type users --entity-name testuser`                                                                                         |
| 查看topics配置项    | `kafka-configs --zookeeper banana:2181 --entity-type topics --entity-name topicName --describe`                                                                                                                    |
| 查看brokers配置项    | `kafka-configs --bootstrap-server banana:9092 --entity-type brokers --entity-name $brokerId [--entity-default] --describe`                                                                                                         |
| 增加/修改配置项 | `kafka-configs --zookeeper banana:2181 --alter --entity-type topics --entity-name topicName --add-config 'retention.ms=3000, k2=v2, k3=v3' `                                                                       |
| 删除配置项    | `kafka-configs --zookeeper banana:2181 --alter --entity-type topics --entity-name topicName --delete-config retention.ms`                                                                                          |

<br/>  

未测试

| 功能                  | 命令                                                                                                                                                               |
|---------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 添加用户（SCRAM-SHA-256） | `kafka-configs --bootstrap-server banana:9092 --alter --add-config 'SCRAM-SHA-256=[iterations=8192,password=123456]' --entity-type users --entity-name testuser` |
| 添加用户（SCRAM-SHA-512） | `kafka-configs --bootstrap-server banana:9092 --alter --add-config 'SCRAM-SHA-512=[iterations=8192,password=123456]' --entity-type users --entity-name testuser` |
| 查看用户配置              | `kafka-configs --bootstrap-server banana:9092 --describe --entity-type users --entity-name testuser`                                                           |
| 删除用户                | `kafka-configs --bootstrap-server banana:9092 --alter --delete-config 'SCRAM-SHA-256' --entity-type users --entity-name testuser`                                |

---

#### 📌 ACL 权限控制

|功能| 命令                                                                                                                                                                                                                                      |
|---|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|给用户授权 Topic 读写| `kafka-acls --authorizer kafka.security.auth.SimpleAclAuthorizer --authorizer-properties zookeeper.connect=banana:2181 --add --allow-principal User:producer --operation Write [--operation Read/describe] --topic=* [--allow-host ip]` |
|给用户授权消费组权限| `kafka-acls --authorizer kafka.security.auth.SimpleAclAuthorizer --authorizer-properties zookeeper.connect=banana:2181 --add --allow-principal User:testuser --operation Read --group group1`                                           |
|查看 ACL| `kafka-acls --authorizer kafka.security.auth.SimpleAclAuthorizer --authorizer-properties zookeeper.connect=banana:2181 --list`                                                                                                                                                                                      |
|删除 ACL| `kafka-acls --authorizer kafka.security.auth.SimpleAclAuthorizer --authorizer-properties zookeeper.connect=banana:2181 --remove --allow-principal User:testuser --operation Read --operation Write --topic test`                                                                                                    |

<br/>

未测试

|功能| 命令                                                                                                                                                      |
|---|---------------------------------------------------------------------------------------------------------------------------------------------------------|
|给用户授权 Topic 读写| `kafka-acls --bootstrap-server banana:9092 --add --allow-principal User:testuser --operation Read --operation Write --topic test`    |
|给用户授权消费组权限| `kafka-acls --bootstrap-server banana:9092 --add --allow-principal User:testuser --operation Read --group my-group`                  |
|查看 ACL| `kafka-acls --bootstrap-server banana:9092 --list`                                                                                   |
|删除 ACL| `kafka-acls --bootstrap-server banana:9092 --remove --allow-principal User:testuser --operation Read --operation Write --topic test` |

---

#### 📌 Leader 重新选举


|功能| 命令                                                                                                          |
|---|-------------------------------------------------------------------------------------------------------------|
|所有Topic所有分区用重新PREFERRED：优先副本策略 进行Leader重选举| `kafka-leader-election --bootstrap-server banana:9092 --election-type preferred  --all-topic-partitions`    |
|指定Topic指定分区用重新PREFERRED：优先副本策略 进行Leader重选举| `kafka-leader-election --bootstrap-server banana:9092 --topic test --election-type preferred --partition 1` |


---

#### 📌 其他脚本

- 重新分区：bin/kafka-reassign-partitions.sh
- 负载均衡：
  ```commandline
    kafka-preferred-replica-election --zookeeper banana/kafka --path-to-json-file xxx.json
    
    {"partitions":
        [{"topic": "foo", "partition": 1}, {"topic": "foobar", "partition": 2}]
    }
    ```
- 配置auto.leader.rebalance.enable=true实现topic Leader的自动负载均衡
- 增加副本因子
- kafka-replica-verification.sh
  ```commandline
  bin/kafka-replica-verification.sh --broker-list banana:9092 [--topic-white-list test]
  
  参数--topic-white-list指定要检查的目标topic
  ```

---

#### 📌 运维相关

|功能| 命令                                                                                                                                                   |
|---|------------------------------------------------------------------------------------------------------------------------------------------------------|
|查看 Broker 配置| `kafka-configs --bootstrap-server banana:9092 --describe --entity-type brokers --entity-name 0`                                   |
|修改 Broker 配置| `kafka-configs --bootstrap-server banana:9092 --alter --entity-type brokers --entity-name 0 --add-config log.retention.hours=168` |
|查看 Kafka 版本| `kafka-broker-api-versions --bootstrap-server banana:9092`                                                                        |
